<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Multiplayer Shooter</title>
<style>
:root{
  --primary:#4caf50; --accent:#2196f3; --danger:#e53935; --bg:#121212; --ring:rgba(76,175,80,.45);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#fff;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;overflow:hidden}

/* backdrop */
body::before{
  content:"";position:fixed;inset:-20%;
  background:
    radial-gradient(800px 400px at 20% 10%, rgba(76,175,80,.10), transparent 60%),
    radial-gradient(800px 400px at 80% 90%, rgba(33,150,243,.10), transparent 60%);
  filter:blur(30px);opacity:.7;pointer-events:none;z-index:0;
  animation:drift 22s linear infinite;
}
@keyframes drift{0%{transform:translate3d(0,0,0)}50%{transform:translate3d(2%,-2%,0)}100%{transform:translate3d(0,0,0)}}

.screen{display:none;height:100vh;width:100vw;align-items:center;justify-content:center;position:relative;z-index:1}
.screen.active{display:flex}
.card{
  background:rgba(255,255,255,.92);color:#222;padding:18px;border-radius:14px;width:360px;max-width:94%;
  box-shadow:0 10px 28px rgba(0,0,0,.35);backdrop-filter:blur(8px);animation:pop-in .35s ease-out both;
}
@keyframes pop-in{from{opacity:0;transform:translateY(10px) scale(.98)}to{opacity:1;transform:none}}

input{
  width:100%;padding:10px;margin:8px 0;border-radius:10px;border:1px solid #ddd;font-size:15px;
  transition:box-shadow .2s,border-color .2s,transform .12s;
}
input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(76,175,80,.15),0 6px 14px rgba(0,0,0,.15);outline:none;transform:translateY(-1px)}

button{
  width:100%;padding:12px;border-radius:12px;border:none;background:var(--primary);color:#fff;font-size:15px;cursor:pointer;
  position:relative;overflow:hidden;transition:transform .12s ease, box-shadow .2s ease, filter .2s ease;box-shadow:0 10px 22px rgba(0,0,0,.30);
}
button:hover{transform:translateY(-1px);box-shadow:0 14px 26px rgba(0,0,0,.35)}
button:active{transform:translateY(0) scale(.98);filter:brightness(.98)}
button.secondary{background:var(--accent);margin-top:8px}
.msg{margin-top:8px;color:#e53935;min-height:18px}

#gameCanvas{display:block;margin:6vh auto 0;border:3px solid var(--primary);border-radius:12px;background:#222;touch-action:none;transition:box-shadow .25s,border-color .2s}
#gameCanvas:hover{box-shadow:0 0 0 3px var(--ring), 0 12px 30px rgba(0,0,0,.35);border-color:var(--primary)}

/* === Chat: compact toggle + panel === */
#chatToggle{
  position:fixed;left:12px;top:12px;background:var(--primary);border:none;padding:8px 12px;border-radius:999px;color:#121212;cursor:pointer;
  user-select:none;z-index:10000;box-sizing:border-box;font-weight:bold;display:flex;gap:8px;align-items:center;justify-content:center;
  width:auto; /* override global button width */
}
#chatToggle.is-active{box-shadow:0 0 0 3px var(--ring)}
#chatToggle .badge{display:none;background:#e53935;color:#fff;border-radius:999px;padding:0 6px;font-size:12px;line-height:18px;min-width:18px;text-align:center}

#chatContainer{
  position:fixed;left:12px;top:54px;width:260px;max-width:92vw;background:rgba(0,0,0,.88);padding:6px;border-radius:12px;font-size:13px;user-select:text;z-index:9999;box-sizing:border-box;max-height:60vh;
  display:flex;flex-direction:column;backdrop-filter:blur(6px);opacity:0;transform:translateY(-8px) scale(.98);pointer-events:none;transition:opacity .18s ease, transform .18s ease;
  border:1px solid rgba(255,255,255,.08); box-shadow:0 10px 24px rgba(0,0,0,.4);
}
#chatContainer.is-open{opacity:1;transform:none;pointer-events:auto}
#chatHeader{display:flex;align-items:center;justify-content:space-between;padding:4px 6px;border-bottom:1px solid var(--primary)}
#chatHeader .title{font-weight:700;color:#c8facc}
#chatHeader .actions{display:flex;gap:6px}
#chatMessages{flex:1;overflow-y:auto;padding:6px 4px 6px 0;word-wrap:break-word}
#chatMessages::-webkit-scrollbar{width:8px}
#chatMessages::-webkit-scrollbar-thumb{background:rgba(255,255,255,.22);border-radius:8px}
#chatInputContainer{display:flex;gap:6px;margin-top:6px}
#chatInput{flex:1;padding:8px;border-radius:10px;border:none;background:#121212;color:#fff;font-size:13px;outline:none}
#chatSend{padding:8px 10px;background:var(--primary);border:none;color:#fff;border-radius:10px;cursor:pointer;user-select:none;min-width:64px;width:auto}
.chat-btn{width:auto;padding:6px 10px;border-radius:8px;background:#1a1f25;border:1px solid #2a2f36;color:#eaeaea}

/* joystick & shoot */
.joystick{position:fixed;left:14px;bottom:14px;width:110px;height:110px;border-radius:50%;background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;touch-action:none;z-index:50}
.joystick .pad{position:relative;width:72px;height:72px;border-radius:50%;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center}
.joystick .knob{position:absolute;width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.12);left:50%;top:50%;transform:translate(-50%,-50%);touch-action:none;transition:box-shadow .2s}
.joystick.active .knob{box-shadow:0 0 0 8px rgba(76,175,80,.15), 0 0 18px rgba(76,175,80,.5)}
.shoot-btn{
  position:fixed;right:24px;bottom:24px;width:72px;height:72px;border-radius:50%;background:var(--danger);display:flex;align-items:center;justify-content:center;font-weight:bold;z-index:50;color:#fff;user-select:none;cursor:pointer;
  box-shadow:0 10px 24px rgba(229,57,53,.35);animation:breathe 2.2s ease-in-out infinite;transition:transform .12s;
}
.shoot-btn:active{transform:scale(.96)}
@keyframes breathe{0%,100%{box-shadow:0 6px 18px rgba(229,57,53,.28)}50%{box-shadow:0 10px 28px rgba(229,57,53,.45)}}

@media (max-width:480px){
  #chatContainer{width:230px}
}
</style>
</head>
<body>

<!-- Login -->
<div id="loginScreen" class="screen active">
  <div class="card">
    <h1>Login / Create Room</h1>
    <input id="loginUsername" placeholder="ชื่อผู้เล่น" maxlength="15" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <input id="loginRoom" placeholder="ชื่อห้อง" maxlength="20" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <input id="loginRoomCode" placeholder="รหัสห้อง 4 หลัก" maxlength="4" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <button id="loginBtn">Login to Room</button>
    <div style="text-align:center;margin:10px 0;color:#666;font-weight:bold">OR</div>
    <input id="createRoomName" placeholder="สร้างห้อง: ชื่อห้อง" maxlength="20" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <input id="createRoomCode" placeholder="รหัสห้อง 4 หลัก" maxlength="4" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
    <button id="createRoomBtn" class="secondary">Create Room</button>
    <div id="loginError" class="msg"></div>
  </div>
</div>

<!-- Lobby -->
<div id="lobbyScreen" class="screen">
  <div class="card" style="background:transparent;color:#fff;text-align:center">
    <h2>Welcome, <span id="lobbyUsername"></span></h2>
    <h3>Room: <span id="lobbyRoom"></span> (Code: <span id="lobbyRoomCode"></span>)</h3>
    <button id="startGameBtn">Start Game</button>
  </div>
</div>

<!-- Gameplay -->
<div id="gameplayScreen" class="screen">
  <!-- compact chat -->
  <button id="chatToggle" title="เปิด/ปิดแชท">Chat <span class="badge" id="chatBadge">0</span></button>
  <div id="chatContainer" aria-live="polite">
    <div id="chatHeader">
      <div class="title">Chat</div>
      <div class="actions">
        <button id="clearChat" class="chat-btn">Clear</button>
        <button id="closeChat" class="chat-btn">Hide</button>
      </div>
    </div>
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
      <input id="chatInput" placeholder="พิมพ์ข้อความ..." disabled autocomplete="off"/>
      <button id="chatSend">ส่ง</button>
    </div>
  </div>

  <div class="joystick" id="joystick">
    <div class="pad"><div class="knob" id="knob"></div></div>
  </div>
  <div class="shoot-btn" id="shootBtn">F</div>

  <canvas id="gameCanvas"></canvas>
</div>

<!-- ===== Resolve server base + load socket.io ===== -->
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const param = qs.get('server');         // "ip:port" หรือ "ip"
  let host = (param && param.split(':')[0]) || localStorage.getItem('serverHost');
  let port = (param && param.split(':')[1]) || localStorage.getItem('serverPort');
  const isHttp = location.protocol === 'http:' || location.protocol === 'https:';
  if (!host) host = isHttp ? location.hostname : 'localhost';
  if (!port) port = isHttp && location.port ? location.port : '3000';
  const proto = isHttp ? location.protocol : 'http:';
  window.__SERVER_BASE__ = `${proto}//${host}:${port}`;
  if (param) { localStorage.setItem('serverHost', host); localStorage.setItem('serverPort', port); }

  const s = document.createElement('script');
  s.src = window.__SERVER_BASE__ + '/socket.io/socket.io.js';
  s.onload = () => initClient();
  s.onerror = () => { console.error('Cannot load socket.io from', s.src); alert('โหลด socket.io ไม่ได้: ' + s.src); };
  document.head.appendChild(s);
})();
</script>

<script>
function initClient(){
  const socket = io(window.__SERVER_BASE__);

  /* Refs */
  const loginScreen = document.getElementById('loginScreen');
  const lobbyScreen = document.getElementById('lobbyScreen');
  const gameplayScreen = document.getElementById('gameplayScreen');

  const loginUsername = document.getElementById('loginUsername');
  const loginRoom = document.getElementById('loginRoom');
  const loginRoomCode = document.getElementById('loginRoomCode');
  const loginBtn = document.getElementById('loginBtn');

  const createRoomName = document.getElementById('createRoomName');
  const createRoomCode = document.getElementById('createRoomCode');
  const createRoomBtn = document.getElementById('createRoomBtn');

  const loginError = document.getElementById('loginError');
  const lobbyUsername = document.getElementById('lobbyUsername');
  const lobbyRoom = document.getElementById('lobbyRoom');
  const lobbyRoomCode = document.getElementById('lobbyRoomCode');
  const startGameBtn = document.getElementById('startGameBtn');

  const chatToggle = document.getElementById('chatToggle');
  const chatBadge = document.getElementById('chatBadge');
  const chatContainer = document.getElementById('chatContainer');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');
  const closeChat = document.getElementById('closeChat');
  const clearChat = document.getElementById('clearChat');

  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  const joystick = document.getElementById('joystick');
  const knob = document.getElementById('knob');
  const shootBtn = document.getElementById('shootBtn');

  /* State */
  let username='', roomName='', roomCode='';
  let players={}, bullets=[], myId=null; let started=false;
  let unread=0, chatOpen=false;

  let local = { x:400, y:300, angle:0, isShooting:false, hp:100 };
  let keys = {}; let joystickActive=false, joyCenter={x:0,y:0}, joyId=null;

  /* Helpers */
  function resizeCanvas(){ if(window.innerWidth<=768){canvas.width=window.innerWidth; canvas.height=Math.floor(window.innerHeight*0.72);} else{canvas.width=800; canvas.height=600;} }
  resizeCanvas(); window.addEventListener('resize', resizeCanvas);

  function showScreen(s){ loginScreen.classList.remove('active'); lobbyScreen.classList.remove('active'); gameplayScreen.classList.remove('active'); s.classList.add('active'); }
  const isValidCode = c => /^\d{4}$/.test(String(c));
  function clampLocal(){ local.x=Math.max(0,Math.min(canvas.width,local.x)); local.y=Math.max(0,Math.min(canvas.height,local.y)); }

  function setChatOpen(open){
    chatOpen=open;
    chatContainer.classList.toggle('is-open', open);
    chatToggle.classList.toggle('is-active', open);
    if(open){ unread=0; chatBadge.style.display='none'; chatInput.focus(); chatMessages.scrollTop=chatMessages.scrollHeight; }
  }

  /* Create Room */
  createRoomBtn.addEventListener('click', async ()=>{
    loginError.style.color='red'; loginError.textContent='';
    const rn=createRoomName.value.trim(), rc=createRoomCode.value.trim();
    if(!rn){ loginError.textContent='กรุณากรอกชื่อห้อง'; return; }
    if(!isValidCode(rc)){ loginError.textContent='รหัสห้องต้อง 4 หลัก'; return; }
    try{
      const r=await fetch(window.__SERVER_BASE__+'/createRoom',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomName:rn,roomCode:String(rc)})});
      const j=await r.json();
      if(j.success){ loginError.style.color='green'; loginError.textContent='สร้างห้องสำเร็จ'; }
      else{ loginError.textContent=j.error||'สร้างห้องล้มเหลว'; }
    }catch(e){ loginError.textContent='เชื่อมต่อไม่สำเร็จ'; }
  });

  /* Login */
  loginBtn.addEventListener('click', async ()=>{
    loginError.style.color='red'; loginError.textContent='';
    const un=loginUsername.value.trim(), rn=loginRoom.value.trim(), rc=loginRoomCode.value.trim();
    if(un.length<3){ loginError.textContent='ชื่อผู้เล่นอย่างน้อย 3 ตัว'; return; }
    if(!rn){ loginError.textContent='กรุณากรอกชื่อห้อง'; return; }
    if(!isValidCode(rc)){ loginError.textContent='รหัสห้องต้อง 4 หลัก'; return; }
    try{
      const r=await fetch(window.__SERVER_BASE__+'/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:un,roomName:rn,roomCode:String(rc)})});
      const j=await r.json();
      if(j.success){
        username=un; roomName=rn; roomCode=String(rc);
        lobbyUsername.textContent=username; lobbyRoom.textContent=roomName; lobbyRoomCode.textContent=roomCode;
        showScreen(lobbyScreen);
      }else{ loginError.textContent=j.error||'ล็อกอินล้มเหลว'; }
    }catch(e){ loginError.textContent='เชื่อมต่อไม่สำเร็จ'; }
  });

  /* Join/Start */
  startGameBtn.addEventListener('click', ()=>{
    if(!username||!roomName||!roomCode) return;
    socket.emit('joinRoom',{username,roomName,roomCode});
    showScreen(gameplayScreen);
    startGame();
  });

  /* Chat */
  chatToggle.addEventListener('click', ()=> setChatOpen(!chatOpen));
  closeChat.addEventListener('click', ()=> setChatOpen(false));
  clearChat.addEventListener('click', ()=> chatMessages.innerHTML='');

  chatSend.addEventListener('click', ()=>{
    if(chatInput.disabled) return;
    const msg=chatInput.value.trim(); if(!msg) return;
    socket.emit('chat message', msg); chatInput.value='';
  });
  chatInput.addEventListener('keypress', e=>{ if(e.key==='Enter') chatSend.click(); });

  /* Socket events */
  socket.on('errorMsg', msg => { if(!started){ loginError.style.color='red'; loginError.textContent=msg; showScreen(loginScreen);} else{ alert(msg);} });
  socket.on('registered', id => { myId=id; chatInput.disabled=false; });
  socket.on('playersUpdate', data => { players=data||{}; });
  socket.on('gameState', state => { if(state){ players=state.players||players; bullets=state.bullets||bullets; } });

  socket.on('chat message', ({username: from, message})=>{
    const row=document.createElement('div'); row.style.marginBottom='6px';
    const name=document.createElement('span'); name.style.color='#9be7a0'; name.style.fontWeight='700'; name.textContent=from+': ';
    const text=document.createElement('span'); text.textContent=String(message);
    row.appendChild(name); row.appendChild(text);
    chatMessages.appendChild(row); chatMessages.scrollTop=chatMessages.scrollHeight;

    if(!chatOpen){ unread+=1; chatBadge.textContent=String(unread); chatBadge.style.display='inline-block'; }
  });

  socket.on('dead', ()=>{ alert('คุณตาย รอสปอร์นอัตโนมัติ...'); setTimeout(()=> socket.emit('respawnRequest'),1); });
  socket.on('respawn', ({x,y,hp})=>{ if(myId&&players[myId]){ players[myId].x=x; players[myId].y=y; players[myId].hp=hp; players[myId].dead=false; } });

  /* Keyboard */
  window.addEventListener('keydown', e=>{ keys[e.key.toLowerCase()]=true; if(e.key===' ') local.isShooting=true; });
  window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()]=false; if(e.key===' ') local.isShooting=false; });

  /* Mouse aim */
  canvas.addEventListener('mousemove', e=>{
    const r=canvas.getBoundingClientRect(); const mx=e.clientX-r.left, my=e.clientY-r.top;
    local.angle=Math.atan2(my-local.y,mx-local.x);
  });

  /* Joystick touch */
  function centerOf(el){ const r=el.getBoundingClientRect(); return {x:r.left+r.width/2,y:r.top+r.height/2}; }
  joystick.addEventListener('touchstart', e=>{
    e.preventDefault(); if(joystickActive) return;
    const t=e.changedTouches[0]; joystickActive=true; joyId=t.identifier; joyCenter=centerOf(joystick);
    joystick.classList.add('active'); knob.style.transform='translate(0,0)';
  },{passive:false});
  joystick.addEventListener('touchmove', e=>{
    e.preventDefault(); if(!joystickActive) return;
    let touch=null; for(let i=0;i<e.touches.length;i++){ if(e.touches[i].identifier===joyId){ touch=e.touches[i]; break; } }
    if(!touch) return;
    const dx=touch.clientX-joyCenter.x, dy=touch.clientY-joyCenter.y, max=36;
    const dist=Math.hypot(dx,dy); const nx=dist>max?(dx/dist)*max:dx; const ny=dist>max?(dy/dist)*max:dy;
    knob.style.transform=`translate(${nx}px,${ny}px)`; local.x+=(nx/max)*3; local.y+=(ny/max)*3; clampLocal();
  },{passive:false});
  function joyOff(){ joystickActive=false; joyId=null; knob.style.transform='translate(0,0)'; joystick.classList.remove('active'); }
  joystick.addEventListener('touchend', e=>{ for(let i=0;i<e.changedTouches.length;i++){ if(e.changedTouches[i].identifier===joyId){ joyOff(); break; } } },{passive:false});
  joystick.addEventListener('touchcancel', joyOff, {passive:true});

  /* Right-side touch aim/shoot */
  let rightId=null;
  canvas.addEventListener('touchstart', e=>{
    for(let i=0;i<e.touches.length;i++){
      const t=e.touches[i];
      if(t.clientX>window.innerWidth/2){
        rightId=t.identifier; const r=canvas.getBoundingClientRect();
        local.angle=Math.atan2((t.clientY-r.top)-local.y,(t.clientX-r.left)-local.x);
      }
    }
  },{passive:false});
  canvas.addEventListener('touchmove', e=>{
    for(let i=0;i<e.touches.length;i++){
      const t=e.touches[i];
      if(t.identifier===rightId){ const r=canvas.getBoundingClientRect();
        local.angle=Math.atan2((t.clientY-r.top)-local.y,(t.clientX-r.left)-local.x);
      }
    }
  },{passive:false});
  canvas.addEventListener('touchend', e=>{
    for(let i=0;i<e.changedTouches.length;i++){
      const t=e.changedTouches[i]; if(t.identifier===rightId){ rightId=null; local.isShooting=true; }
    }
  },{passive:false});

  shootBtn.addEventListener('touchstart', e=>{ e.preventDefault(); local.isShooting=true; },{passive:false});

  /* Main loop */
  function drawPlayer(p,isMe){
    ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.angle||0);
    ctx.fillStyle=isMe?'#4caf50':'#2196f3'; ctx.fillRect(-15,-10,30,20);
    ctx.fillStyle='#333'; ctx.fillRect(0,-5,20,10); ctx.restore();
    ctx.fillStyle='#fff'; ctx.font='12px sans-serif'; ctx.textAlign='center'; ctx.fillText(p.username||'Player',p.x,p.y-20);
    const w=40,h=6,hx=p.x-w/2,hy=p.y-10; ctx.fillStyle='#555'; ctx.fillRect(hx,hy,w,h);
    const percent=Math.max(0,Math.min(1,(p.hp||0)/100)); ctx.fillStyle=`rgb(${Math.floor(255*(1-percent))},${Math.floor(255*percent)},0)`; ctx.fillRect(hx,hy,w*percent,h);
  }

  function loop(){
    const speed=4;
    if(keys['w']||keys['arrowup']) local.y-=speed;
    if(keys['s']||keys['arrowdown']) local.y+=speed;
    if(keys['a']||keys['arrowleft']) local.x-=speed;
    if(keys['d']||keys['arrowright']) local.x+=speed;
    clampLocal();

    socket.emit('playerMove',{x:Math.round(local.x),y:Math.round(local.y),angle:local.angle||0,isShooting:!!local.isShooting,username});
    local.isShooting=false;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const id in players){ const p=players[id]; if(!p) continue; drawPlayer(p,id===myId); }
    ctx.fillStyle='#fff'; (bullets||[]).forEach(b=>{ ctx.beginPath(); ctx.arc(b.x,b.y,5,0,Math.PI*2); ctx.fill(); });

    requestAnimationFrame(loop);
  }

  function startGame(){ if(started) return; started=true; local.x=canvas.width/2; local.y=canvas.height/2; requestAnimationFrame(loop); }

  // prevent scroll on mobile
  document.body.addEventListener('touchmove', e=>{
    if(e.target===canvas || e.target===joystick || e.target===knob){ e.preventDefault(); }
  },{passive:false});
}
</script>
</body>
</html>
